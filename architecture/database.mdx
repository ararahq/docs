---
title: "Banco de Dados"
description: "Estrutura e modelagem do banco de dados da Arara API."
---

# Banco de Dados da Arara API

A Arara API utiliza **PostgreSQL** como sistema de gerenciamento de banco de dados relacional. Ele é a espinha dorsal que armazena todas as informações críticas da plataforma, desde dados de usuários e workspaces até o registro detalhado de todas as mensagens enviadas.

## Visão Geral

O banco de dados da Arara é projetado para suportar as principais funcionalidades da plataforma com foco em confiabilidade, escalabilidade e rastreabilidade:

- Gerenciamento de usuários e workspaces (contas de empresas).
- Armazenamento e validação de chaves de API.
- Registro e status de templates de mensagem.
- Log completo de todas as mensagens enviadas, incluindo agendamentos e erros.

## Modelo de Dados e Migrações

<Card title="Abordagem Via Migrações" icon="diagram-project">
  Em vez de um diagrama visual estático, apresentamos a estrutura do banco de dados através dos nossos scripts de migração, que são a **fonte da verdade** do nosso esquema. Isso garante que a documentação reflita exatamente o que está implementado.
</Card>

O esquema inicial do banco de dados é estabelecido através do nosso primeiro script de migração, garantindo que todas as alterações sejam versionadas e controladas.

### Estrutura de Diretórios de Migrações

Nossas migrações são organizadas da seguinte forma:

```
src/main/resources/db/
├── changelog.xml            # Arquivo mestre de migração (geralmente Liquibase)
└── scripts/
    ├── 001-initial-schema.sql  # Esquema inicial com todas as tabelas
    └── ...                  # Futuras migrações incrementais
```

### Esquema Inicial (V1__Create_Tables.sql)

O script `V1__Create_Tables.sql` define a estrutura fundamental de todas as tabelas da Arara API. Você pode expandir abaixo para ver o conteúdo completo:

<AccordionGroup>
  <Accordion title="Visualizar Esquema Inicial (V1__Create_Tables.sql)">
    ```sql
    -- Armazena os usuários que se autenticam via Firebase.
    CREATE TABLE users (
        firebase_uid VARCHAR(255) PRIMARY KEY,
        email VARCHAR(255) UNIQUE NOT NULL,
        name VARCHAR(255),
        test_whatsapp_number VARCHAR(50),
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    
    -- Um workspace é o "time" ou "conta da empresa".
    CREATE TABLE workspaces (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        name VARCHAR(255) NOT NULL,
        plan VARCHAR(50) NOT NULL DEFAULT 'free',
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    
    -- Vincula usuários a workspaces com uma permissão.
    CREATE TABLE workspace_members (
        workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
        user_firebase_uid VARCHAR(255) NOT NULL REFERENCES users(firebase_uid) ON DELETE CASCADE,
        role VARCHAR(50) NOT NULL, -- Ex: 'owner', 'member'
        PRIMARY KEY (workspace_id, user_firebase_uid)
    );
    
    -- Armazena as chaves de API, que pertencem a um workspace.
    CREATE TABLE api_keys (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        hashed_key VARCHAR(255) NOT NULL UNIQUE,
        prefix VARCHAR(10) NOT NULL UNIQUE,
        mode VARCHAR(10) NOT NULL, -- 'live' ou 'test'
        workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        revoked_at TIMESTAMPTZ
    );
    
    -- Armazena os templates de mensagem criados por um workspace.
    CREATE TABLE templates (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
        name VARCHAR(255) NOT NULL,
        body TEXT NOT NULL,
        category VARCHAR(50) NOT NULL,
        status VARCHAR(50) NOT NULL, -- 'pending', 'approved', 'rejected'
        meta_template_id VARCHAR(255),
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        UNIQUE(workspace_id, name)
    );
    
    -- O log de todas as mensagens enviadas.
    CREATE TABLE messages (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
        api_key_id UUID REFERENCES api_keys(id),
        template_id UUID REFERENCES templates(id),
        recipient VARCHAR(50) NOT NULL,
        status VARCHAR(50) NOT NULL,
        mode VARCHAR(10) NOT NULL,
        error_message TEXT,
        provider_message_id VARCHAR(255),
        scheduled_at TIMESTAMPTZ,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    ```
  </Accordion>
</AccordionGroup>

---

## Principais Tabelas

(O conteúdo desta seção permanece o mesmo, descrevendo cada tabela individualmente)

### `users`

Armazena os usuários que se autenticam via Firebase e que interagem com o Dashboard da Arara.

| Coluna                 | Tipo           | Descrição                                            |
| ---------------------- | -------------- | ---------------------------------------------------- |
| `firebase_uid`         | `VARCHAR(255)` | **PK**. ID único do usuário fornecido pelo Firebase. |
| `email`                | `VARCHAR(255)` | Email do usuário (único e obrigatório).              |
| `name`                 | `VARCHAR(255)` | Nome de exibição do usuário.                         |
| `test_whatsapp_number` | `VARCHAR(50)`  | Número de WhatsApp para o "Dev Mode" do usuário.     |
| `created_at`           | `TIMESTAMPTZ`  | Data e hora de criação do registro.                  |

### `workspaces`

Representa as "contas de empresas" ou "times" dentro da Arara. Todos os recursos (API Keys, Templates, Mensagens) são vinculados a um workspace.

| Coluna       | Tipo           | Descrição                                     |
| ------------ | -------------- | --------------------------------------------- |
| `id`         | `UUID`         | **PK**. Identificador único do workspace.     |
| `name`       | `VARCHAR(255)` | Nome do workspace.                            |
| `plan`       | `VARCHAR(50)`  | Plano atual do workspace (ex: 'free', 'pro'). |
| `created_at` | `TIMESTAMPTZ`  | Data e hora de criação do registro.           |

### `workspace_members`

Tabela de junção para vincular usuários a workspaces e definir suas permissões.

| Coluna              | Tipo           | Descrição                                                     |
| ------------------- | -------------- | ------------------------------------------------------------- |
| `workspace_id`      | `UUID`         | **PK, FK**. ID do workspace ao qual o membro pertence.        |
| `user_firebase_uid` | `VARCHAR(255)` | **PK, FK**. ID do usuário (Firebase UID) membro do workspace. |
| `role`              | `VARCHAR(50)`  | Papel do usuário no workspace (ex: 'owner', 'member').        |

### `api_keys`

Armazena as chaves de API geradas pelos workspaces. As chaves são armazenadas como hash por segurança.

| Coluna         | Tipo           | Descrição                                               |
| -------------- | -------------- | ------------------------------------------------------- |
| `id`           | `UUID`         | **PK**. Identificador único da chave de API.            |
| `hashed_key`   | `VARCHAR(255)` | Hash criptográfico da chave de API (único).             |
| `prefix`       | `VARCHAR(10)`  | Prefixo da chave (ex: 'sk_test\_', 'sk_live\_').        |
| `mode`         | `VARCHAR(10)`  | Modo da chave ('live' ou 'test').                       |
| `workspace_id` | `UUID`         | **FK**. Workspace ao qual a chave pertence.             |
| `created_at`   | `TIMESTAMPTZ`  | Data e hora de criação da chave.                        |
| `revoked_at`   | `TIMESTAMPTZ`  | Data e hora em que a chave foi revogada (se aplicável). |

### `templates`

Armazena os templates de mensagem de WhatsApp criados e gerenciados pelos workspaces.

| Coluna             | Tipo           | Descrição                                                |
| ------------------ | -------------- | -------------------------------------------------------- |
| `id`               | `UUID`         | **PK**. Identificador único do template.                 |
| `workspace_id`     | `UUID`         | **FK**. Workspace proprietário do template.              |
| `name`             | `VARCHAR(255)` | Nome do template (único por workspace).                  |
| `body`             | `TEXT`         | Conteúdo do template.                                    |
| `category`         | `VARCHAR(50)`  | Categoria do template (ex: 'utility', 'marketing').      |
| `status`           | `VARCHAR(50)`  | Status de aprovação ('pending', 'approved', 'rejected'). |
| `meta_template_id` | `VARCHAR(255)` | ID do template na Meta (após aprovação).                 |
| `created_at`       | `TIMESTAMPTZ`  | Data e hora de criação do template.                      |

### `messages`

Log de todas as mensagens enviadas através da Arara API.

| Coluna                | Tipo           | Descrição                                            |
| --------------------- | -------------- | ---------------------------------------------------- |
| `id`                  | `UUID`         | **PK**. Identificador único da mensagem.             |
| `workspace_id`        | `UUID`         | **FK**. Workspace que enviou a mensagem.             |
| `api_key_id`          | `UUID`         | **FK**. Chave de API usada para enviar a mensagem.   |
| `template_id`         | `UUID`         | **FK**. Template usado para a mensagem.              |
| `recipient`           | `VARCHAR(50)`  | Número do destinatário.                              |
| `status`              | `VARCHAR(50)`  | Status da mensagem (ex: 'queued', 'sent', 'failed'). |
| `mode`                | `VARCHAR(10)`  | Modo do envio ('live' ou 'test').                    |
| `error_message`       | `TEXT`         | Mensagem de erro, se houver falha no envio.          |
| `provider_message_id` | `VARCHAR(255)` | ID da mensagem no provedor (Meta).                   |
| `scheduled_at`        | `TIMESTAMPTZ`  | Data e hora agendada para o envio.                   |
| `created_at`          | `TIMESTAMPTZ`  | Data e hora de criação do registro da mensagem.      |

## Índices

O banco de dados utiliza índices para otimizar consultas frequentes e garantir a performance:

| Tabela              | Coluna(s)            | Tipo   | Descrição                                                               |
| ------------------- | -------------------- | ------ | ----------------------------------------------------------------------- |
| `users`             | `email`              | UNIQUE | Garante emails únicos e acelera consultas por email.                    |
| `workspaces`        | `name`               | BTREE  | Otimiza a busca e ordenação por nome de workspace.                      |
| `workspace_members` | `workspace_id`       | BTREE  | Acelera a recuperação de membros de um workspace.                       |
| `workspace_members` | `user_firebase_uid`  | BTREE  | Acelera a recuperação de workspaces de um usuário.                      |
| `api_keys`          | `workspace_id`       | BTREE  | Otimiza a busca por chaves de API de um workspace.                      |
| `api_keys`          | `prefix`             | UNIQUE | Garante prefixos únicos para chaves de API.                             |
| `templates`         | `workspace_id, name` | UNIQUE | Garante que um workspace não tenha dois templates com o mesmo nome.     |
| `templates`         | `workspace_id`       | BTREE  | Otimiza a busca por templates de um workspace.                          |
| `messages`          | `workspace_id`       | BTREE  | Acelera a recuperação de mensagens de um workspace.                     |
| `messages`          | `recipient`          | BTREE  | Otimiza a busca por mensagens enviadas para um destinatário específico. |
| `messages`          | `created_at`         | BTREE  | Otimiza consultas por data/período de envio de mensagens.               |
| `messages`          | `scheduled_at`       | BTREE  | Otimiza consultas para mensagens agendadas.                             |

## Considerações de Performance e Segurança

### Performance

- **Índices Estratégicos**: Aplicados nas colunas mais utilizadas em cláusulas `WHERE` e `JOIN`.
- **Consultas Otimizadas**: Desenvolvimento de queries eficientes e monitoramento contínuo.
- **Paginação**: Implementada em todas as consultas que retornam grandes volumes de dados (ex: logs de mensagens).

### Segurança de Dados

- **Criptografia**: API Keys são armazenadas como **hash** (`hashed_key`), nunca em texto puro.
- **Acesso Restrito**: O acesso ao banco de dados é rigidamente controlado e limitado apenas aos serviços e usuários autorizados.
- **Integridade Referencial**: Chaves estrangeiras são utilizadas para garantir a consistência e integridade dos dados entre as tabelas.
- **Backups**: Configuração de backups automáticos para recuperação de desastres.