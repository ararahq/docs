---
title: 'Webhooks Universais'
description: 'Receba notificações em tempo real sobre mensagens, status e templates com segurança HMAC'
---

# Webhooks Universais

A Arara utiliza um sistema de **Webhooks Universais** para notificar o seu backend em tempo real sempre que algo importante acontece. Nossa infraestrutura foi desenhada para ser robusta, segura (nível Stripe) e fácil de integrar.

## O Que São Webhooks?

Webhooks são chamadas HTTP `POST` que a Arara faz para uma URL configurada por você. Em vez de você consultar nossa API repetidamente para saber se uma mensagem foi lida ou se um template foi aprovado, **nós avisamos você**.

<Info>
  **Segurança e Flexibilidade**: Nosso sistema suporta assinaturas **HMAC-SHA256**. Se você configurar um `Secret` no dashboard, todas as requisições serão assinadas. Se não configurar, o sistema continua funcionando em modo legado para não quebrar sua integração.
</Info>

---

## Estrutura Universal do Payload

Todos os eventos enviados pela Arara seguem o mesmo padrão de estrutura:

```json
{
  "event": "nome.do.evento",
  "data": {
    // Dados específicos do evento
  },
  "timestamp": "2024-02-12T13:00:00Z",
  "organizationId": "uuid-da-sua-organizacao"
}
```

---

## Eventos de Mensagens

### `message.received` (Inbound)
Disparado quando um cliente envia uma mensagem para o seu número dedicado.

**Payload:**
```json
{
  "event": "message.received",
  "data": {
    "id": "SM123456...",
    "from": "5511999999999",
    "to": "551140040000",
    "body": "Olá, gostaria de saber mais sobre o produto!",
    "type": "text",
    "media_url": "https://ararahq.com/l/abc123" // URL encurtada pela Arara
  }
}
```

### `message.status_updated`
Disparado sempre que o status de uma mensagem enviada muda (entregue, lida ou falha).

**Exemplo de Falha com Diagnóstico:**
```json
{
  "event": "message.status_updated",
  "data": {
    "messageId": "uuid-da-mensagem",
    "status": "failed",
    "errorDetails": {
      "code": "ararahq-63024",
      "whatHappened": "O número de destino não é um WhatsApp válido.",
      "howToAct": "Verifique se o número possui WhatsApp antes de enviar."
    }
  }
}
```

---

## Eventos de Templates

### `template.updated`
Extremamente útil para automação de fluxos. Avisa você no segundo em que a Meta aprova ou rejeita o seu template.

**Payload:**
```json
{
  "event": "template.updated",
  "data": {
    "templateId": "uuid-do-template",
    "name": "boas_vindas_v1",
    "status": "APPROVED", // APPROVED, REJECTED ou PAUSED
    "category": "MARKETING",
    "rejectionReason": null // Preenchido em caso de REJECTED
  }
}
```

---

## Segurança (HMAC-SHA256)

Para garantir que a requisição veio realmente da Arara e não foi alterada, enviamos dois cabeçalhos de assinatura:

- `X-Arara-Signature`: O hash HMAC-SHA256 do payload.
- `X-Arara-Signature-V2`: O hash no formato `sha256={hash}`.

### Como Validar a Assinatura

Use o seu `Webhook Secret` (configurado em API Keys > Webhooks no dashboard) como chave secreta para calcular o HMAC do corpo bruto (raw body) da requisição.

**Exemplo em Node.js:**

```javascript
const crypto = require('crypto');

app.post('/webhook', (req, res) => {
  const signature = req.headers['x-arara-signature'];
  const secret = process.env.ARARA_WEBHOOK_SECRET;
  
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(JSON.stringify(req.body))
    .digest('hex');

  if (signature !== expectedSignature) {
    return res.status(401).send('Invalid Signature');
  }

  // Processar o evento com segurança...
  res.status(200).send('OK');
});
```

---

## Resolução de Problemas

<AccordionGroup>
  <Accordion title="Não estou recebendo webhooks">
    1. Verifique se a URL no dashboard está correta.
    2. Certifique-se de que sua URL é acessível via HTTPS público.
    3. Se o evento for `message.received`, confirme que você possui um **Número Dedicado** ativo.
  </Accordion>

  <Accordion title="Erro de assinatura (Invalid Signature)">
    1. Certifique-se de estar usando o `Webhook Secret` correto do dashboard.
    2. Valide se você está calculando o HMAC sobre o **corpo bruto (raw body)** da requisição, sem modificações de espaços ou ordenação de JSON.
  </Accordion>
</AccordionGroup>

---

## Próximos Passos

<CardGroup cols={2}>
  <Card title="Diagnósticos de Erro" icon="stethoscope" href="/architecture/error-diagnostics">
    Entenda a fundo os códigos de erro da Arara
  </Card>
  <Card title="Gerenciar Templates" icon="rectangle-list" href="/business-rules/template-management">
    Aprenda as regras de aprovação de templates
  </Card>
</CardGroup>
